<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Gestor de Roles</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root {
      --rojo-teleton: #F3313F;
      --gris-fondo: #f4f4f4;
      --gris-borde: #d9d9d9;
      --gris-texto: #555555;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: "Segoe UI", Arial, sans-serif;
      font-size: 13px;
      background-color: var(--gris-fondo);
      color: var(--gris-texto);
    }
    .topbar {
      height: 50px;
      background-color: #ffffff;
      border-bottom: 1px solid var(--gris-borde);
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 20px;
    }
    .topbar-left { display:flex; align-items:center; gap:12px; }
    .logo { display:flex; align-items:center; gap:6px; font-weight:bold; color:var(--rojo-teleton); font-size:18px; }
    .logo-icon {
      width:26px; height:26px; border-radius:50%;
      border:2px solid var(--rojo-teleton);
      display:inline-flex; align-items:center; justify-content:center;
      font-size:16px;
    }
    .page { padding: 18px 24px 30px; max-width:1200px; margin:0 auto; }
    .page-title { font-size:16px; font-weight:600; margin-bottom:4px; }
    .page-subtitle { font-size:13px; color:#777; margin-bottom:12px; }
    .card {
      background-color:#fff;
      border:1px solid var(--gris-borde);
      padding:18px;
      margin-bottom:20px;
    }
    .form-row { display:flex; align-items:center; margin-bottom:12px; gap:10px; }
    .form-row label { width:90px; font-weight:600; color:var(--gris-texto); }
    input[type="text"], select {
      padding:6px 8px;
      border:1px solid var(--gris-borde);
      border-radius:3px;
      font-size:13px;
      min-width:240px;
      background:#fff;
    }
    input[type="text"]:focus, select:focus { outline:none; border-color:var(--rojo-teleton); }

    .btn-primary, .btn-secondary {
      border:none;
      padding:6px 16px;
      font-size:13px;
      border-radius:3px;
      cursor:pointer;
      font-weight:600;
    }
    .btn-primary { background:var(--rojo-teleton); color:#fff; }
    .btn-primary:hover { background:#d2202f; }
    .btn-secondary { background:#fff; color:var(--rojo-teleton); border:1px solid var(--rojo-teleton); }

    .section-title { font-weight:700; margin-bottom:6px; }

    #rolesChecklist {
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(260px,1fr));
      gap:8px;
      margin-top:10px;
      font-size:13px;
    }

    @media (max-width:820px){
      .form-row { flex-direction:column; align-items:flex-start; }
      .form-row label { width:auto; }
      input[type="text"], select { min-width:100%; width:100%; }
    }
  </style>
</head>
<body>
  <header class="topbar">
    <div class="topbar-left">
      <div class="logo">
        <span class="logo-icon">T</span><span>Teletón</span>
      </div>
      <div class="topbar-menu">Gestor de Roles</div>
    </div>
  </header>

  <main id="profileView" class="page">
    <div class="card">
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <div>
          <div class="page-title">Gestor de Roles</div>
          <div class="page-subtitle">Crear o eliminar perfiles a partir de roles</div>
        </div>
        <div>
          <!-- Botón Limpiar que vuelve a la página principal -->
          <button class="btn-secondary" id="btnVolverPerfil">← Limpiar</button>
        </div>
      </div>

      <div class="form-row">
        <label>Ámbito</label>
        <select id="cmbAmbitoPerfil">
          <option value="Administración">Administración</option>
          <option value="Asistencial">Asistencial</option>
          <option value="Educación">Educación</option>
          <option value="Informática">Informática</option>
          <option value="Dirección Instituto">Dirección Instituto</option>
          <option value="Gerencia">Gerencia</option>
          <option value="Auditoría">Auditoría</option>
          <option value="Gestión">Gestión</option>
        </select>
      </div>

      <div class="form-row">
        <label>Perfil</label>
        <select id="cmbPerfilGestion"></select>
      </div>

      <div class="form-row">
        <label>Nombre</label>
        <input type="text" id="txtNombrePerfil" placeholder="Nombre del nuevo perfil" />
      </div>

      <div class="form-row">
        <label></label>
        <button class="btn-primary" id="btnGuardarPerfil">Guardar perfil</button>
        <button class="btn-secondary" id="btnEliminarPerfil">Eliminar perfil</button>
      </div>

      <hr>

      <div class="section-title">Roles disponibles</div>
      <div class="small-muted">Marca los roles que quieres asociar al perfil.</div>

      <div id="rolesChecklist"></div>
    </div>
  </main>

  <script>
    /********************************************************************
     * Catálogo de roles (todos los códigos -> checkboxes)
     ********************************************************************/
    const rolesCatalogo = {
      "100": "Médico",
      "102": "Tratante indicador con indicaciones",
      "103": "Tratante jefatura",
      "105": "Recepción avanzado",
      "107": "Bloqueo avanzado",
      "108": "Malla operador",
      "109": "Malla administrador",
      "112": "Planificador",
      "114": "Enfermera",
      "116": "Planificación consulta",
      "117": "Agenda consulta",
      "118": "Vista nacional",
      "121": "Reemplazo profesional",
      "123": "Hospitalizado acceso",
      "124": "Hospitalizado prestador",
      "125": "Hospitalizado registro",
      "126": "Admisión",
      "127": "Reprocesar NAT a SGH",
      "128": "Ingreso Evolución",
      "129": "Hospitalizado administración",
      "141": "Donación Autorizador",
      "142": "Donación Asistente Social",
      "143": "Donación Asistente Social Jefatura",
      "144": "Donación Cajero",
      "145": "Donación Cajero Avanzado",
      "146": "Donación Solo Consulta",
      "147": "Usuario Básico SIC",
      "148": "Tratante Telerehabilitación TETCA",
      "149": "Administrativo Informes de Paciente",
      "200": "PowerBI Nacional",
      "201": "PowerBI Arica",
      "202": "PowerBI Iquique",
      "203": "PowerBI Antofagasta",
      "204": "PowerBI Calama",
      "205": "PowerBI Copiapó",
      "206": "PowerBI Coquimbo",
      "207": "PowerBI Valparaíso",
      "208": "PowerBI Talca",
      "209": "PowerBI Concepción",
      "210": "PowerBI Temuco",
      "211": "PowerBI Valdivia",
      "212": "PowerBI Puerto Montt",
      "213": "PowerBI Coyhaique",
      "214": "PowerBI Santiago",
      "215": "Eliminar Documento Repositorio",
      "216": "WeeFim Consulta",
      "217": "WeeFim Evaluador",
      "218": "WeeFim Digitador",
      "219": "WeeFim Administrador",
      "220": "Admisión Orientación",
      "221": "Administrador SIC",
      "305": "Perfil PC Visualización",
      "306": "Perfil PC Médico - Fisiatra",
      "307": "Perfil PC - Kine Terapia",
      "308": "Perfil PC - Educación",
      "310": "Administración de Indicaciones Nacional",
      "311": "Movilización Asistente Social",
      "312": "Movilización Historial Asignaciones",
      "320": "Data Paciente - Profesional Asistencial",
      "321": "Recepción IT Acreditado",
      "322": "Administrativo Informe de Epicrisis",
      "323": "Contingencia: registro atrasado",
      "331": "Exámenes historial y derivación",
      "341": "LOP Administrador",
      "342": "LOP Recepción",
      "343": "LOP Asistencial",
      "344": "LOP Indicador",
      "346": "Fotos y Videos",
      "350": "Farmacia Receta médica",
      "351": "Farmacia Despacho botiquín",
      "352": "Farmacia Informes y Parámetros",
      "353": "Farmacia Solicitud Insumos",
      "354": "Data Paciente - Asistente Social",
      "355": "Data Paciente - Crear Persona",
      "356": "Data Paciente - Editar Persona",
      "358": "Data Paciente - Crea Paciente",
      "359": "Data Paciente - Cambio Estado Paciente",
      "360": "Perfil Social - Asistente Social",
      "364": "Data Paciente - Administrador",
      "366": "Data Paciente - Visualización",
      "367": "Data Paciente - Educación",
      "368": "Data Paciente Administrativo",
      "369": "Data Paciente - Terapéuticos",
      "370": "Data Paciente - Psicología",
      "371": "Visualización Evolución",
      "372": "Cirugía SGH",
      "373": "Comodato SGH",
      "374": "Data Paciente - S. Transversal",
      "375": "Perfil PC - Fonoaudiología",
      "376": "Perfil social - Psicología",
      "377": "Perfil social - Visualización",
      "378": "Perfil social - Educación",
      "382": "Imprimir Evolución"
    };

    /********************************************************************
     * Perfiles base por ámbito (se sobreescriben con lo del storage)
     ********************************************************************/
    const dataPerfiles = {
      "Educación":[
        { id:"educadora", nombre:"Educadora", roles:["102","105","308","320","367","378"] },
        { id:"prof_arte", nombre:"Profesor de arte", roles:["102","105","308","320","367","378"] },
        { id:"prof_musica", nombre:"Profesor de música", roles:["102","105","308","320","367","378"] }
      ],
      "Administración":[
        { id:"analista_sistemas", nombre:"Analista de Sistemas", roles:["105","108","112","147","200","214","305","355","356","358","368"] },
        { id:"adm_recepcion", nombre:"Administrativo recepción", roles:["105","108","112","117","126","144","149","220","321","342","344","359","368"] },
        { id:"adm_informes", nombre:"Administrativo Informes Paciente", roles:["105","149","322","368","371","382"] }
      ],
      "Asistencial":[
        { id:"medico", nombre:"Médico", roles:["100","102","105","123","124","125","200","214","305","306","310","320","331","344","346","350","359","372","373","377"] },
        { id:"kinesiologo", nombre:"Kinesiólogo", roles:["102","105","107","108","116","117","148","200","206","214","216","217","218","307","320","341","344","346","369","372","373","377"] },
        { id:"fonoaudiologo", nombre:"Fonoaudiólogo", roles:["102","105","107","108","116","117","148","200","214","216","217","375","320","344","369","372","373","377"] },
        { id:"psicologo", nombre:"Psicólogo", roles:["100","102","105","200","214","216","217","305","320","346","370","376","377"] },
        { id:"enfermera", nombre:"Enfermera", roles:["102","105","114","200","213","215","220","305","320","342","351","352","353","359","377"] },
        { id:"asistente_social", nombre:"Asistente Social", roles:["102","105","142","143","144","145","146","200","205","206","215","305","311","312","320","331","341","354","359","360","368","371","377"] }
      ],
      "Informática":[],
      "Dirección Instituto":[],
      "Gerencia":[],
      "Auditoría":[],
      "Gestión":[]
    };

    /********************************************************************
     * Persistencia con localStorage (para compartir con Roles-y-perfiles)
     ********************************************************************/
    const STORAGE_KEY_PERFILES = "gestor_roles_perfiles";

    function cargarPerfilesDesdeStorage() {
      const json = localStorage.getItem(STORAGE_KEY_PERFILES);
      if (!json) return;
      try {
        const obj = JSON.parse(json);
        Object.keys(obj).forEach(amb => {
          if (!dataPerfiles[amb]) dataPerfiles[amb] = [];
          dataPerfiles[amb] = obj[amb];
        });
      } catch (e) {
        console.error("Error al leer perfiles desde storage", e);
      }
    }

    function guardarPerfilesEnStorage() {
      localStorage.setItem(STORAGE_KEY_PERFILES, JSON.stringify(dataPerfiles));
    }

    /********************************************************************
     * DOM
     ********************************************************************/
    const btnVolverPerfil   = document.getElementById("btnVolverPerfil");
    const cmbAmbitoPerfil   = document.getElementById("cmbAmbitoPerfil");
    const cmbPerfilGestion  = document.getElementById("cmbPerfilGestion");
    const txtNombrePerfil   = document.getElementById("txtNombrePerfil");
    const btnGuardarPerfil  = document.getElementById("btnGuardarPerfil");
    const btnEliminarPerfil = document.getElementById("btnEliminarPerfil");
    const rolesChecklist    = document.getElementById("rolesChecklist");

    /********************************************************************
     * Lógica Gestor de Roles
     ********************************************************************/
    function cargarComboPerfilesGestion(){
      const ambito = cmbAmbitoPerfil.value;
      const perfilesAmbito = dataPerfiles[ambito] || [];
      cmbPerfilGestion.innerHTML = "";

      const optEmpty = document.createElement("option");
      optEmpty.value = "";
      optEmpty.textContent = "(nuevo perfil)";
      cmbPerfilGestion.appendChild(optEmpty);

      perfilesAmbito.forEach(p => {
        const opt = document.createElement("option");
        opt.value = p.id;
        opt.textContent = p.nombre;
        cmbPerfilGestion.appendChild(opt);
      });

      cmbPerfilGestion.value = "";
    }

    function pintarChecklistRoles(preseleccion){
      rolesChecklist.innerHTML = "";
      const setPre = new Set(preseleccion || []);
      const codigosOrdenados = Object.keys(rolesCatalogo).sort((a,b)=>parseInt(a,10)-parseInt(b,10));
      codigosOrdenados.forEach(cod => {
        const wrapper = document.createElement("label");
        wrapper.style.display = "flex";
        wrapper.style.alignItems = "center";
        wrapper.style.gap = "6px";
        wrapper.style.cursor = "pointer";

        const chk = document.createElement("input");
        chk.type = "checkbox";
        chk.value = cod;
        if(setPre.has(cod)) chk.checked = true;

        const span = document.createElement("span");
        span.textContent = cod + " - " + (rolesCatalogo[cod] || "");

        wrapper.appendChild(chk);
        wrapper.appendChild(span);
        rolesChecklist.appendChild(wrapper);
      });
    }

    cmbAmbitoPerfil.addEventListener("change", () => {
      cargarComboPerfilesGestion();
      txtNombrePerfil.value = "";
      pintarChecklistRoles();
    });

    cmbPerfilGestion.addEventListener("change", () => {
      const ambito = cmbAmbitoPerfil.value;
      const perfilesAmbito = dataPerfiles[ambito] || [];
      const perfilSel = perfilesAmbito.find(p => p.id === cmbPerfilGestion.value);
      const rolesBase = perfilSel ? perfilSel.roles : [];
      pintarChecklistRoles(rolesBase);
      txtNombrePerfil.value = perfilSel ? perfilSel.nombre : "";
    });

    btnGuardarPerfil.addEventListener("click", () => {
      const nombre = txtNombrePerfil.value.trim();
      const ambito = cmbAmbitoPerfil.value;
      const idExistente = cmbPerfilGestion.value || "";

      if(!nombre){
        alert("Debe ingresar un nombre de perfil.");
        return;
      }
      const seleccionados = Array.from(rolesChecklist.querySelectorAll("input[type='checkbox']:checked")).map(c=>c.value);
      if(seleccionados.length === 0){
        alert("Debe seleccionar al menos un rol para el perfil.");
        return;
      }

      const idNormalizado = (idExistente || nombre.toLowerCase()
        .normalize("NFD").replace(/[\u0300-\u036f]/g,"")
        .replace(/[^a-z0-9]+/g,"_")
        .replace(/^_+|_+$/g,""));

      const listaAmbito = dataPerfiles[ambito] || [];
      if(!idExistente && listaAmbito.some(p => p.id === idNormalizado)){
        alert("Ya existe un perfil con un identificador similar. Cambie el nombre.");
        return;
      }

      const nuevoPerfil = {
        id: idNormalizado,
        nombre: nombre,
        roles: Array.from(new Set(seleccionados)).sort((a,b)=>parseInt(a,10)-parseInt(b,10))
      };

      const idx = listaAmbito.findIndex(p => p.id === idNormalizado);
      if(idx >= 0){
        listaAmbito[idx] = nuevoPerfil;
      } else {
        listaAmbito.push(nuevoPerfil);
      }
      dataPerfiles[ambito] = listaAmbito;

      guardarPerfilesEnStorage(); // persiste el cambio

      alert("Perfil guardado en el ámbito seleccionado.");
      cargarComboPerfilesGestion();
      cmbPerfilGestion.value = idNormalizado;
    });

    btnEliminarPerfil.addEventListener("click", () => {
      const ambito = cmbAmbitoPerfil.value;
      const idPerfil = cmbPerfilGestion.value;
      if(!idPerfil){
        alert("Debe seleccionar un perfil para eliminar.");
        return;
      }
      if(!confirm("¿Eliminar el perfil seleccionado del ámbito? Esta acción no modifica los usuarios actuales.")) return;

      const listaAmbito = dataPerfiles[ambito] || [];
      const idx = listaAmbito.findIndex(p => p.id === idPerfil);
      if(idx >= 0){
        listaAmbito.splice(idx,1);
        dataPerfiles[ambito] = listaAmbito;

        guardarPerfilesEnStorage(); // persiste el cambio

        alert("Perfil eliminado.");
        cargarComboPerfilesGestion();
        txtNombrePerfil.value = "";
        pintarChecklistRoles([]);
      } else {
        alert("Perfil no encontrado.");
      }
    });

    btnVolverPerfil.addEventListener("click", () => {
      // Vuelve a la página principal con los cambios ya persistidos
      window.location.href = "https://cesarjimenezb-design.github.io/Roles-y-perfiles/";
    });

    // Inicialización
    cargarPerfilesDesdeStorage();
    cargarComboPerfilesGestion();
    pintarChecklistRoles();
  </script>
</body>
</html>
